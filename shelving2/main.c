#include <math.h>
#include <stdlib.h>
#include <stdio.h>

#ifndef PI
#define PI	3.14159265358979323846
#endif

// TODO: 0. Define your own global coefficients for filtering
#define BUFFER_SIZE		2
//define the buffer size

#define INDEX(CURRENT)	((CURRENT) + BUFFER_SIZE) % BUFFER_SIZE
// if an index is negative, a specified position from the end of the array will be returned.
// e.g. given an array x[8], x[INDEX(-1)] and x[INDEX(7)] both refer to x[7].

/* sample type */
typedef double smp_type;

/* this holds the data required to update samples through a filter */
struct Coef {
	smp_type a1, a2;
	smp_type b0, b1, b2;
};

struct Coef get_shelving_coef(smp_type dbGain, smp_type fc, smp_type fs, smp_type Q)
{
	struct Coef coefficients;

	smp_type K = tan( (PI * fc)/fs );
	smp_type K_squre = K * K;
	smp_type V0 = pow(10, dbGain/20);
	smp_type root2 = 1/Q;

	coefficients.b0 = (V0 + root2 * sqrt(V0) * K + K_squre) / (1 + root2 * K + K_squre);
	coefficients.b1 = (2 * (K_squre - V0) ) / (1 + root2 * K + K_squre);
	coefficients.b2 = (V0 - root2 * sqrt(V0)*K + K_squre) / (1 + root2 * K + K_squre);
	coefficients.a1 = (2 * (K_squre - 1) ) / (1 + root2 * K + K_squre);
	coefficients.a2 = (1 - root2 * K + K_squre) / (1 + root2 * K + K_squre);

	return coefficients;
}

smp_type shelving(smp_type input, struct Coef *coefficients)
{
	static smp_type xBuffer[BUFFER_SIZE] = {0.0};
	// input buffer
	static smp_type yBuffer[BUFFER_SIZE] = {0.0};
	// output buffer

	static int current = 0;

	/* compute output */
	smp_type output = coefficients->b0 * input + coefficients->b1 * xBuffer[INDEX(current-1)] + coefficients->b2 * xBuffer[INDEX(current-2)] - coefficients->a1 * yBuffer[INDEX(current-1)] - coefficients->a2 * yBuffer[INDEX(current-2)];

	xBuffer[current] = input;
	yBuffer[current] = output;

	current++;
	current %= BUFFER_SIZE;

	return output;
}

void pre_emphasis(smp_type data[], int arr_length)
{
	struct Coef coefficients = get_shelving_coef(6, 1000, 16E3, 0.9);
	for (int index = 1; index < arr_length; index++) {
		data[index] = shelving(data[index], &coefficients);
	}
}

smp_type test_input[] = { 0.000000, 0.311155, 0.604528, 0.863541, 1.073937, 
		1.224745, 1.309017, 1.324294, 1.272762, 1.161097, 
		1.000000, 0.803458, 0.587785, 0.370501, 0.169131, 
		0.000000, -0.122881, -0.188780, -0.190983, -0.127255, 
		0.000000, 0.183900, 0.413545, 0.674761, 0.951057, 
		1.224745, 1.478148, 1.694795, 1.860547, 1.964555, 
		2.000000, 1.964555, 1.860547, 1.694795, 1.478148, 
		1.224745, 0.951057, 0.674761, 0.413545, 0.183900, 
		-0.000000, -0.127255, -0.190983, -0.188780, -0.122881, 
		-0.000000, 0.169131, 0.370501, 0.587785, 0.803458, 
		1.000000, 1.161097, 1.272762, 1.324294, 1.309017, 
		1.224745, 1.073937, 0.863541, 0.604528, 0.311155, 
		0.000000, -0.311155, -0.604528, -0.863541, -1.073937, 
		-1.224745, -1.309017, -1.324294, -1.272762, -1.161097, 
		-1.000000, -0.803458, -0.587785, -0.370501, -0.169131, 
		0.000000, 0.122881, 0.188780, 0.190983, 0.127255, 
		-0.000000, -0.183900, -0.413545, -0.674761, -0.951057, 
		-1.224745, -1.478148, -1.694795, -1.860547, -1.964555, 
		-2.000000, -1.964555, -1.860547, -1.694795, -1.478148, 
		-1.224745, -0.951057, -0.674761, -0.413545, -0.183900, 
		-0.000000, 0.127255, 0.190983, 0.188780, 0.122881, 
		0.000000, -0.169131, -0.370501, -0.587785, -0.803458, 
		-1.000000, -1.161097, -1.272762, -1.324294, -1.309017, 
		-1.224745, -1.073937, -0.863541, -0.604528, -0.311155, 
		-0.000000, 0.311155, 0.604528, 0.863541, 1.073937, 
		1.224745, 1.309017, 1.324294, 1.272762, 1.161097, 
		1.000000, 0.803458, 0.587785, 0.370501, 0.169131, 
		0.000000, -0.122881, -0.188780, -0.190983, -0.127255, 
		0.000000, 0.183900, 0.413545, 0.674761, 0.951057, 
		1.224745, 1.478148, 1.694795, 1.860547, 1.964555, 
		2.000000, 1.964555, 1.860547, 1.694795, 1.478148, 
		1.224745, 0.951057, 0.674761, 0.413545, 0.183900, 
		-0.000000, -0.127255, -0.190983, -0.188780, -0.122881, 
		-0.000000, 0.169131, 0.370501, 0.587785, 0.803458, 
		1.000000, 1.161097, 1.272762, 1.324294, 1.309017, 
		1.224745, 1.073937, 0.863541, 0.604528, 0.311155, 
		0.000000, -0.311155, -0.604528, -0.863541, -1.073937, 
		-1.224745, -1.309017, -1.324294, -1.272762, -1.161097, 
		-1.000000, -0.803458, -0.587785, -0.370501, -0.169131, 
		-0.000000, 0.122881, 0.188780, 0.190983, 0.127255, 
		0.000000, -0.183900, -0.413545, -0.674761, -0.951057, 
		-1.224745, -1.478148, -1.694795, -1.860547, -1.964555, 
		-2.000000, -1.964555, -1.860547, -1.694795, -1.478148, 
		-1.224745, -0.951057, -0.674761, -0.413545, -0.183900, 
		-0.000000, 0.127255, 0.190983, 0.188780, 0.122881, 
		0.000000, -0.169131, -0.370501, -0.587785, -0.803458, 
		-1.000000, -1.161097, -1.272762, -1.324294, -1.309017, 
		-1.224745, -1.073937, -0.863541, -0.604528, -0.311155, 
		-0.000000, 0.311155, 0.604528, 0.863541, 1.073937, 
		1.224745, 1.309017, 1.324294, 1.272762, 1.161097, 
		1.000000, 0.803458, 0.587785, 0.370501, 0.169131, 
		0.000000, -0.122881, -0.188780, -0.190983, -0.127255, 
		-0.000000, 0.183900, 0.413545, 0.674761, 0.951057, 
		1.224745, 1.478148, 1.694795, 1.860547, 1.964555, 
		2.000000, 1.964555, 1.860547, 1.694795, 1.478148, 
		1.224745, 0.951057, 0.674761, 0.413545, 0.183900, 
		0.000000, -0.127255, -0.190983, -0.188780, -0.122881, 
		-0.000000, 0.169131, 0.370501, 0.587785, 0.803458, 
		1.000000, 1.161097, 1.272762, 1.324294, 1.309017, 
		1.224745, 1.073937, 0.863541, 0.604528, 0.311155, 
		-0.000000, -0.311155, -0.604528, -0.863541, -1.073937, 
		-1.224745, -1.309017, -1.324294, -1.272762, -1.161097, 
		-1.000000, -0.803458, -0.587785, -0.370501, -0.169131, 
		-0.000000, 0.122881, 0.188780, 0.190983, 0.127255, 
		-0.000000, -0.183900, -0.413545, -0.674761, -0.951057, 
		-1.224745, -1.478148, -1.694795, -1.860547, -1.964555, 
		-2.000000, -1.964555, -1.860547, -1.694795, -1.478148, 
		-1.224745, -0.951057, -0.674761, -0.413545, -0.183900, 
		-0.000000, 0.127255, 0.190983, 0.188780, 0.122881, 
		0.000000, -0.169131, -0.370501, -0.587785, -0.803458, 
		-1.000000, -1.161097, -1.272762, -1.324294, -1.309017, 
		-1.224745, -1.073937, -0.863541, -0.604528, -0.311155, 
		-0.000000, 0.311155, 0.604528, 0.863541, 1.073937, 
		1.224745, 1.309017, 1.324294, 1.272762, 1.161097, 
		1.000000, 0.803458, 0.587785, 0.370501, 0.169131, 
		0.000000, -0.122881, -0.188780, -0.190983, -0.127255, 
		0.000000, 0.183900, 0.413545, 0.674761, 0.951057, 
		1.224745, 1.478148, 1.694795, 1.860547, 1.964555, 
		2.000000, 1.964555, 1.860547, 1.694795, 1.478148, 
		1.224745, 0.951057, 0.674761, 0.413545, 0.183900, 
		0.000000, -0.127255, -0.190983, -0.188780, -0.122881, 
		-0.000000, 0.169131, 0.370501, 0.587785, 0.803458, 
		1.000000, 1.161097, 1.272762, 1.324294, 1.309017, 
		1.224745, 1.073937, 0.863541, 0.604528, 0.311155, 
		0.000000, -0.311155, -0.604528, -0.863541, -1.073937, 
		-1.224745, -1.309017, -1.324294, -1.272762, -1.161097, 
		-1.000000, -0.803458, -0.587785, -0.370501, -0.169131, 
		-0.000000, 0.122881, 0.188780, 0.190983, 0.127255, 
		0.000000, -0.183900, -0.413545, -0.674761, -0.951057, 
		-1.224745, -1.478148, -1.694795, -1.860547, -1.964555, 
		-2.000000, -1.964555, -1.860547, -1.694795, -1.478148, 
		-1.224745, -0.951057, -0.674761, -0.413545, -0.183900, 
		-0.000000, 0.127255, 0.190983, 0.188780, 0.122881, 
		0.000000, -0.169131, -0.370501, -0.587785, -0.803458, 
		-1.000000, -1.161097, -1.272762, -1.324294, -1.309017, 
		-1.224745, -1.073937, -0.863541, -0.604528, -0.311155, 
		-0.000000, 0.311155, 0.604528, 0.863541, 1.073937, 
		1.224745, 1.309017, 1.324294, 1.272762, 1.161097, 
		1.000000, 0.803458, 0.587785, 0.370501, 0.169131, 
		0.000000, -0.122881, -0.188780, -0.190983, -0.127255, 
		-0.000000, 0.183900, 0.413545, 0.674761, 0.951057, 
		1.224745, 1.478148, 1.694795, 1.860547, 1.964555, 
		2.000000, 1.964555, 1.860547, 1.694795, 1.478148, 
		1.224745, 0.951057, 0.674761, 0.413545, 0.183900, 
		0.000000, -0.127255, -0.190983, -0.188780, -0.122881, 
		-0.000000, 0.169131, 0.370501, 0.587785, 0.803458, 
		1.000000, 1.161097, 1.272762, 1.324294, 1.309017, 
		1.224745, 1.073937, 0.863541, 0.604528, 0.311155, 
		0.000000, -0.311155, -0.604528, -0.863541, -1.073937, 
		-1.224745, -1.309017, -1.324294, -1.272762, -1.161097, 
		-1.000000, -0.803458, -0.587785, -0.370501, -0.169131, 
		-0.000000, 0.122881, 0.188780, 0.190983, 0.127255, 
		-0.000000, -0.183900, -0.413545, -0.674761, -0.951057, 
		-1.224745, -1.478148, -1.694795, -1.860547, -1.964555, 
		-2.000000, -1.964555, -1.860547, -1.694795, -1.478148, 
		-1.224745, -0.951057, -0.674761, -0.413545, -0.183900, 
		-0.000000, 0.127255, 0.190983, 0.188780, 0.122881, 
		0.000000, -0.169131, -0.370501, -0.587785, -0.803458, 
		-1.000000, -1.161097, -1.272762, -1.324294, -1.309017, 
		-1.224745, -1.073937, -0.863541, -0.604528, -0.311155 };

int main() {
	int window_length = 360;

	pre_emphasis(test_input, window_length);

	for (int i = 0; i < window_length; ++i) {
		printf("%.4f\t", test_input[i]);
	}
	return 0;
}
