#include <stdio.h>
#include <math.h>
#include <stdlib.h>

#define FEAT_NUM        12
#define STATE_NUM       5

float test_input[18][FEAT_NUM] = {
	{-16.681906, 6.087717, 2.390434, 0.232071, -1.225417, -1.507493, -1.282729, -1.087818, -0.981075, -0.823016, -0.912036, -0.832075},
	{-15.754005, 7.220482, 2.731196, 0.027516, -1.921565, -1.665574, -0.962624, -0.521149, -0.394428, -0.224880, -0.590567, -0.740767},
	{-14.886635, 7.522751, 2.376703, 0.229444, -2.547874, -1.230166, -0.998631, -0.764926, -0.405403, -0.151963, -0.252777, -0.677893},
	{-13.452543, 7.518717, 2.297773, 0.298150, -2.649593, -1.351853, -1.022569, -0.747487, -0.377254, -0.298008, -0.215301, -0.572234},
	{-11.834751, 7.144723, 2.640096, 0.410373, -2.799223, -1.124777, -1.500907, -0.580436, -0.200475, -0.334032, 0.068566, -0.483386},
	{-10.157672, 6.796714, 2.921605, 0.462396, -4.220464, -0.078633, -1.961881, -0.571732, -0.141882, -0.643033, 0.146373, -0.123903},
	{-6.180136, 6.039442, 2.125645, -0.868513, -3.182580, -0.632985, -1.513999, -0.355103, -0.196039, -0.635510, 0.085315, -0.124427},
	{-3.636743, 5.751954, 1.483710, -1.681069, -3.863545, 0.593872, -0.486290, -0.689209, -0.320246, -0.328275, -0.470398, -0.359179},
	{-0.832388, 5.346994, -0.217842, -1.868113, -3.705178, 0.740520, 0.215701, -0.581965, -0.599269, -0.400369, -0.319752, -0.447152},
	{0.854550, 5.241096, -2.297707, -0.906461, -3.735073, 1.383124, 0.079785, -0.597083, -0.968327, -0.035039, -0.481041, -0.512507},
	{2.911508, 4.048878, -2.872818, -0.637072, -3.076904, 1.744950, -0.201236, -0.637205, -1.201555, 0.041426, -0.318323, -0.442790},
	{3.518468, 3.647319, -2.907437, -1.130607, -2.113594, 1.726874, -0.211826, -0.853304, -1.285036, -0.015483, -0.164914, -0.469783},
	{3.964244, 2.925623, -2.301615, -1.290647, -1.473401, 1.820669, -0.834982, -0.624393, -1.187623, -0.012943, -0.390484, -0.392833},
	{2.746197, 3.157597, -2.013094, -0.804172, -1.418582, 1.829418, -1.013314, -0.710049, -1.051463, 0.098911, -0.364074, -0.577428},
	{0.474078, 4.011804, -1.451385, -0.543760, -1.343198, 1.705765, -1.264779, -0.348313, -1.076750, 0.108426, -0.094109, -0.362995},
	{-2.157344, 4.662204, -0.374911, -0.558091, -1.219016, 1.484538, -1.341950, -0.376067, -0.598382, -0.043121, 0.145904, -0.762332},
	{-6.423768, 4.398304, 0.277399, 0.747066, -0.737431, 0.945007, -0.951427, -1.216710, -0.325489, 0.262322, -0.155679, -0.561924},
	{-7.704023, 3.489149, 1.269971, 0.924836, -0.204166, 0.809042, -1.357946, -1.077550, -0.823563, 1.235458, -0.796451, -0.410074}
};

float mu[5][12] = {
	{1.022314e+00, 4.020255e+00, -4.243671e-01, -4.471526e-01, -1.519863e+00, -2.127658e-01, 1.860481e-02, -5.419477e-01, -2.394766e-01, -2.628134e-01, -2.944465e-01, -3.661556e-01},
	{5.353616e+00, 3.027350e+00, -1.979536e+00, -1.515952e+00, -1.659604e+00, 1.045648e+00, -2.826921e-01, -3.180028e-01, -5.412513e-01, 2.855773e-01, -9.296453e-01, -1.387303e-01},
	{2.377692e+00, 3.505987e+00, -1.057862e+00, -6.442869e-01, -3.394007e-01, 3.447078e-01, -9.523113e-01, -7.771586e-01, 5.185604e-02, -7.887811e-02, -3.249707e-01, -5.199103e-01},
	{-6.550688e+00, 4.405169e+00, 2.536493e-01, 8.735071e-01, 1.544557e-02, 5.404139e-01, -5.153842e-01, -1.134864e+00, -2.755637e-01, -1.341596e-01, -5.511040e-01, -5.448580e-01},
	{-1.019745e+01, 4.667619e+00, 1.024119e+00, 1.386422e+00, 5.085613e-01, 6.236764e-01, -4.990899e-01, -1.033201e+00, 3.955495e-01, -3.469191e-01, -1.885460e-01, -3.565321e-01}
};
float inv_Var[5][12] = {
	{1.043116e-02, 1.367196e-01, 2.343735e-01, 9.319836e-01, 4.137256e-01, 1.801337e+00, 1.361804e+00, 3.159525e+00, 3.692915e+00, 4.396384e+00, 6.108255e+00, 4.625409e+00},
	{1.166542e-01, 6.856497e-01, 1.044001e+00, 2.440860e+00, 3.747818e-01, 4.435774e+00, 2.686050e+00, 7.752792e+00, 4.681721e+00, 4.792876e+00, 7.296033e+00, 7.504572e+00},
	{5.214461e-02, 2.090712e+00, 1.489239e+00, 3.990552e+00, 5.914362e-01, 8.324458e-01, 1.716234e+00, 4.655102e+00, 1.582623e+00, 6.640904e+00, 4.469129e+00, 1.889586e+01},
	{4.518273e-02, 1.056030e+00, 1.443741e+00, 1.923127e+00, 2.164687e+00, 4.970042e+00, 2.155709e+00, 5.452831e+00, 2.421934e+00, 3.986759e+00, 4.881377e+00, 1.052028e+01},
	{3.068099e-01, 6.716827e+00, 3.500437e+00, 4.846323e+01, 1.794388e+02, 1.444013e+01, 1.376819e+01, 4.032748e+02, 1.075989e+01, 9.118168e+01, 2.357781e+02, 2.884564e+01}
};
float det_part[5] = {
	1.100142e-05, 1.513253e-03, 7.729531e-04, 1.481335e-03, 2.977399e+03
};

void calc_emis(int obvs_length, float obvs[][FEAT_NUM], float *ptr_to_emis)
{
	int state;
	int row_num;
	int feat_num;

	for (state = 0; state < STATE_NUM; state++) {
		for (row_num = 0; row_num < obvs_length; row_num++) {

			float trans = 0;
			for (feat_num = 0; feat_num < FEAT_NUM; feat_num++) {
				float obvs_minus_mu = obvs[row_num][feat_num] - mu[state][feat_num];

				trans += obvs_minus_mu * inv_Var[state][feat_num] * obvs_minus_mu;
			}

			float exp_part = expf(-0.5 * trans);

			*(ptr_to_emis + state * obvs_length + row_num) = det_part[state] * exp_part;

		}
	}
}

int main()
{
	int obvs_length = 18;
	float *emis = (float*) calloc(STATE_NUM * obvs_length, sizeof(float));
	calc_emis(obvs_length, test_input, emis);

	for (int i = 0; i < STATE_NUM; ++i) {
		for (int j = 0; j < obvs_length; ++j) {
			printf("%e\t", *(emis + i*obvs_length + j));
		}
		printf("\n");
	}
	return 0;
}
