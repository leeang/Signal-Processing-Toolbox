#include <stdio.h>
#include <math.h>

int bank_border[] = { 4, 361, 764, 1218, 1730, 2307, 2958, 3692, 4519, 5452, 6503, 7689, 9025, 10532, 12231, 14146, 16305, 18740, 21484, 24578, 28067, 32000 };
static float bank_gain[20][59] = {0.0};

float power[] = {
	0.382617452181876, 0.401177709349412, 0.615121824340840, 0.908976073408407, 1.58173639088690, 3.06131970243679, 8.52278538746869, 57.0286174728006, 179.534997766131, 16.5518244951977, 5.59875281346226, 3.72311699080789, 2.07596830654814, 2.67501201004686, 10.3666599895356, 271.429382248814, 36.9113987830020, 6.76172176601196, 2.99173318694475, 2.25091826555399, 1.44121532736771, 1.12302550970305, 1.40307794225805, 0.750571161014293, 0.226787036704575, 0.341362275950634, 0.321845291923854, 0.347916272636134, 0.383968749893015, 0.508701361874106, 1.17437356701817, 0.164201644399558, 0.0453238513460198, 0.0847696235044609, 0.0929865178261895, 0.0847451336656928, 0.0856707145724844, 0.119952046805278, 0.209079620807392, 0.205801363332580, 0.0922541448455720, 0.0683356708739068, 0.0828096280762478, 0.0733628808017635, 0.0747795708916723, 0.0891450131271101, 0.0294518714659803, 0.0444888449556845, 0.0531316683232966, 0.0535672604820088, 0.0378123144302335, 0.0553760885611318, 0.0690558627242470, 0.165307900741866, 0.0350027598210689, 0.0202557483885975, 0.0220117673951314, 0.0356647999583298, 0.0240270602339303, 0.0167260250699279, 0.0598568244091755, 0.148009946806250, 0.117497789928374, 0.0645448721070073, 0.0287627829637468, 0.0365667550947774, 0.0393619316383383, 0.0215557371319536, 0.0985610216541450, 0.00758971164128569, 0.0213027050932453, 0.0478866102486267, 0.0512645961132276, 0.0620762195025345, 0.0375677597390082, 0.192620457612017, 0.380429710255437, 0.338868148434320, 0.106980890314316, 0.0576249508599359, 0.0139458511181346, 0.135116720342117, 0.151457725664934, 0.143585781327980, 0.362230044578066, 0.0176441565908908, 0.0141263727942443, 0.0257919144868442, 0.0531980361851767, 0.0428383591452262, 0.0548105182422599, 0.0173720715448485, 0.179047194858716, 0.0878663368997137, 0.0109294645777535, 0.0449721068912482, 0.0916237379844638, 0.0177389227650962, 0.200130794390224, 0.357015694299175, 0.00863795314937996, 0.00728211970154151, 0.0334248144405777, 0.00815105526687528, 0.0120504855448760, 0.00766826694018302, 0.0173425381476460, 0.0428754828683920, 0.0313991795322707, 0.0144409118912802, 0.0143207682278645, 0.0265276402024662, 0.0126494462597900, 0.00299135091236312, 0.0130725383972283, 0.00371893162251320, 0.0225726603227675, 0.0138777705235958, 0.00772430215998575, 0.0203219073968288, 0.0151948513080736, 0.00131407884010809, 0.0468224689831988, 0.00756237309122300, 0.00346001349355079, 0.00859018591441349, 0.0157131310177520, 0.0127984487472374, 0.0124467397108674, 0.00779154095798025, 0.0350658928392712, 0.0298282810147632, 0.0180507241684419, 0.00488238465627842, 0.0172811816280169, 0.0380989991889649, 0.0409589859531891, 0.0534739344022849, 0.00632208834652313, 0.0204755227376296, 0.0362250115140586, 0.0148612093518071, 0.102915918419265, 0.482865183218929, 0.593374599538383, 0.795986779327826, 0.429983580615873, 0.131084564161380, 0.0414316323947668, 0.0269722370639387, 0.00116933822838778, 0.136370342190983, 0.0986879612854063, 0.00800716248614054, 0.00468965281959974, 0.00623653805168742, 0.00906193340493377, 0.00208067489038580, 0.00244623101881872, 0.0651484720976836, 0.0255952077200893, 0.0724795072748745, 0.0393604943404917, 0.00434474002589856, 0.0134751470579822, 0.00736915207199327, 0.0846954416885289, 0.130170240966756, 0.0623517309496728, 0.105372082826054, 0.104974731489573, 0.0192536181706328, 0.0491748964797902, 0.0627721508538698, 0.0521795985629616, 0.00476875055478691, 0.0173042296425740, 0.00967881499424970, 0.00285606668005615, 0.00466032136825299, 0.00656398562541806, 0.0115608645759710, 0.00449839720611205, 0.00789684147555138, 0.00561428471806347, 0.00967443266690037, 0.00704554228534720, 0.00166690090459218, 0.00741795315855318, 0.0227355248507640, 0.0125241691810375, 0.00827452279009823, 0.00122629753983613, 0.00372483739653938, 0.0108481207307769, 0.0148824420222624, 0.00918265981504889, 0.00224585990223586, 0.00377768619153450, 0.0109398561599201, 0.0141032253356771, 0.00735784635704521, 0.00139768717831917, 0.00543951953885350, 0.0102619278086288, 0.00903655474915641, 0.00326941405551261, 0.00204836547377366, 0.00657094567040111, 0.0111116901838395, 0.0112117655766737, 0.00326214382453432, 0.000965255479729156, 0.00813271977385581, 0.00869819264586031, 0.00863540320888300, 0.00217462469435603, 0.00162733352261836, 0.0113038758335324, 0.0257036678538228, 0.00131397458860564, 0.00155568887004413, 0.00367137050613106, 0.0247431316464718, 0.00774175358643384, 0.00924923331345922, 0.00427186369789006, 0.0634534508156624, 0.0122335137510643, 0.0120730050336343, 0.00378322678012623, 0.0156987908494505, 0.0189416410587338, 0.00570275090835210, 0.00700261689431082, 0.00896551938512747, 0.00280050796755519, 0.0138610854272812, 0.00250220684494523, 0.00354002158976070, 0.00581823630402480, 0.00670342657708903, 0.00167615759311540, 0.0127639624162182, 0.00426546521529541, 0.00733512487176158, 0.00235687505315915, 0.00727371036979489, 0.00985426284941274, 0.00930797229739577, 0.00363168266239049, 0.00596720833673617, 0.00594390735797629, 0.00515407642053660, 0.00462096157436732, 0.00470242379376078, 0.00462722126394510, 0.00470242379376078, 0.00462096157436732, 0.00515407642053660, 0.00594390735797629, 0.00596720833673617, 0.00363168266239049, 0.00930797229739577, 0.00985426284941274, 0.00727371036979489, 0.00235687505315915, 0.00733512487176158, 0.00426546521529541, 0.0127639624162182, 0.00167615759311540, 0.00670342657708903, 0.00581823630402480, 0.00354002158976070, 0.00250220684494523, 0.0138610854272812, 0.00280050796755519, 0.00896551938512747, 0.00700261689431082, 0.00570275090835210, 0.0189416410587338, 0.0156987908494505, 0.00378322678012623, 0.0120730050336343, 0.0122335137510643, 0.0634534508156624, 0.00427186369789006, 0.00924923331345922, 0.00774175358643384, 0.0247431316464718, 0.00367137050613106, 0.00155568887004413, 0.00131397458860564, 0.0257036678538228, 0.0113038758335324, 0.00162733352261836, 0.00217462469435603, 0.00863540320888300, 0.00869819264586031, 0.00813271977385581, 0.000965255479729156, 0.00326214382453432, 0.0112117655766737, 0.0111116901838395, 0.00657094567040111, 0.00204836547377366, 0.00326941405551261, 0.00903655474915641, 0.0102619278086288, 0.00543951953885350, 0.00139768717831917, 0.00735784635704521, 0.0141032253356771, 0.0109398561599201, 0.00377768619153450, 0.00224585990223586, 0.00918265981504889, 0.0148824420222624, 0.0108481207307769, 0.00372483739653938, 0.00122629753983613, 0.00827452279009823, 0.0125241691810375, 0.0227355248507640, 0.00741795315855318, 0.00166690090459218, 0.00704554228534720, 0.00967443266690037, 0.00561428471806347, 0.00789684147555138, 0.00449839720611205, 0.0115608645759710, 0.00656398562541806, 0.00466032136825299, 0.00285606668005615, 0.00967881499424970, 0.0173042296425740, 0.00476875055478691, 0.0521795985629616, 0.0627721508538698, 0.0491748964797902, 0.0192536181706328, 0.104974731489573, 0.105372082826054, 0.0623517309496728, 0.130170240966756, 0.0846954416885289, 0.00736915207199327, 0.0134751470579822, 0.00434474002589856, 0.0393604943404917, 0.0724795072748745, 0.0255952077200893, 0.0651484720976836, 0.00244623101881872, 0.00208067489038580, 0.00906193340493377, 0.00623653805168742, 0.00468965281959974, 0.00800716248614054, 0.0986879612854063, 0.136370342190983, 0.00116933822838778, 0.0269722370639387, 0.0414316323947668, 0.131084564161380, 0.429983580615873, 0.795986779327826, 0.593374599538383, 0.482865183218929, 0.102915918419265, 0.0148612093518071, 0.0362250115140586, 0.0204755227376296, 0.00632208834652313, 0.0534739344022849, 0.0409589859531891, 0.0380989991889649, 0.0172811816280169, 0.00488238465627842, 0.0180507241684419, 0.0298282810147632, 0.0350658928392712, 0.00779154095798025, 0.0124467397108674, 0.0127984487472374, 0.0157131310177520, 0.00859018591441349, 0.00346001349355079, 0.00756237309122300, 0.0468224689831988, 0.00131407884010809, 0.0151948513080736, 0.0203219073968288, 0.00772430215998575, 0.0138777705235958, 0.0225726603227675, 0.00371893162251320, 0.0130725383972283, 0.00299135091236312, 0.0126494462597900, 0.0265276402024662, 0.0143207682278645, 0.0144409118912802, 0.0313991795322707, 0.0428754828683920, 0.0173425381476460, 0.00766826694018302, 0.0120504855448760, 0.00815105526687528, 0.0334248144405777, 0.00728211970154151, 0.00863795314937996, 0.357015694299175, 0.200130794390224, 0.0177389227650962, 0.0916237379844638, 0.0449721068912482, 0.0109294645777535, 0.0878663368997137, 0.179047194858716, 0.0173720715448485, 0.0548105182422599, 0.0428383591452262, 0.0531980361851767, 0.0257919144868442, 0.0141263727942443, 0.0176441565908908, 0.362230044578066, 0.143585781327980, 0.151457725664934, 0.135116720342117, 0.0139458511181346, 0.0576249508599359, 0.106980890314316, 0.338868148434320, 0.380429710255437, 0.192620457612017, 0.0375677597390082, 0.0620762195025345, 0.0512645961132276, 0.0478866102486267, 0.0213027050932453, 0.00758971164128569, 0.0985610216541450, 0.0215557371319536, 0.0393619316383383, 0.0365667550947774, 0.0287627829637468, 0.0645448721070073, 0.117497789928374, 0.148009946806250, 0.0598568244091755, 0.0167260250699279, 0.0240270602339303, 0.0356647999583298, 0.0220117673951314, 0.0202557483885975, 0.0350027598210689, 0.165307900741866, 0.0690558627242470, 0.0553760885611318, 0.0378123144302335, 0.0535672604820088, 0.0531316683232966, 0.0444888449556845, 0.0294518714659803, 0.0891450131271101, 0.0747795708916723, 0.0733628808017635, 0.0828096280762478, 0.0683356708739068, 0.0922541448455720, 0.205801363332580, 0.209079620807392, 0.119952046805278, 0.0856707145724844, 0.0847451336656928, 0.0929865178261895, 0.0847696235044609, 0.0453238513460198, 0.164201644399558, 1.17437356701817, 0.508701361874106, 0.383968749893015, 0.347916272636134, 0.321845291923854, 0.341362275950634, 0.226787036704575, 0.750571161014293, 1.40307794225805, 1.12302550970305, 1.44121532736771, 2.25091826555399, 2.99173318694475, 6.76172176601196, 36.9113987830020, 271.429382248814, 10.3666599895356, 2.67501201004686, 2.07596830654814, 3.72311699080789, 5.59875281346226, 16.5518244951977, 179.534997766131, 57.0286174728006, 8.52278538746869, 3.06131970243679, 1.58173639088690, 0.908976073408407, 0.615121824340840, 0.401177709349412
};

void calc_bank_gain(void)
{
	float temp;

	int bank_num;
	for (bank_num = 0; bank_num < 20; bank_num++) {
		int x_length_inc = bank_border[bank_num+1] - bank_border[bank_num];
		int x_length_dec = bank_border[bank_num+2] - bank_border[bank_num+1];

		int offset = bank_border[bank_num]/125;

		int index = 1;
		int frequency_x4 = (index+offset) * 125;

		while (frequency_x4 <= bank_border[bank_num+1]) {
			temp = (float)(frequency_x4 - bank_border[bank_num]) / (float)x_length_inc;
			bank_gain[bank_num][index-1] = temp;
			index++;
			frequency_x4 = (index+offset) * 125;
		}

		while( frequency_x4 <= bank_border[bank_num+2] ) {
			temp = 1 - (float)(frequency_x4 - bank_border[bank_num+1]) / (float)x_length_dec;
			bank_gain[bank_num][index-1] = temp;
			index++;
			frequency_x4 = (index+offset) * 125;
		}
	}
}

void mel_filter(float power[], float energy_melband[])
{
	int bank_num;
	for (bank_num = 0; bank_num < 20; bank_num++) {
		int offset = bank_border[bank_num]/125;

		int L = bank_border[bank_num+2]/125 - bank_border[bank_num]/125;

		int index;
		for (index = 0; index < L; index++) {
			energy_melband[bank_num] = energy_melband[bank_num] + power[index+offset+1] * bank_gain[bank_num][index];
		}

		energy_melband[bank_num] = log10f(energy_melband[bank_num]);
	}
}

int main()
{
	calc_bank_gain();

	float energy_melband[20] = {0.0};
	mel_filter(power, energy_melband);

	int bank_num;
	for (bank_num = 0; bank_num < 20; bank_num++) {
		printf("%f\t", energy_melband[bank_num]);
	}

	return 0;
}
