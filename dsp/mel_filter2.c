#include <math.h>
#include <stdlib.h>

#include <fract.h>

int bank_border[] = { 4, 361, 764, 1218, 1730, 2307, 2958, 3692, 4519, 5452, 6503, 7689, 9025, 10532, 12231, 14146, 16305, 18740, 21484, 24578, 28067, 32000 };
fract16 bank_gain[20][59] = {0x0000};

float power[] = {
		0.382617, 0.401178, 0.615122, 0.908976, 1.581736, 
		3.061320, 8.522785, 57.028617, 179.534998, 16.551824, 
		5.598753, 3.723117, 2.075968, 2.675012, 10.366660, 
		271.429382, 36.911399, 6.761722, 2.991733, 2.250918, 
		1.441215, 1.123026, 1.403078, 0.750571, 0.226787, 
		0.341362, 0.321845, 0.347916, 0.383969, 0.508701, 
		1.174374, 0.164202, 0.045324, 0.084770, 0.092987, 
		0.084745, 0.085671, 0.119952, 0.209080, 0.205801, 
		0.092254, 0.068336, 0.082810, 0.073363, 0.074780, 
		0.089145, 0.029452, 0.044489, 0.053132, 0.053567, 
		0.037812, 0.055376, 0.069056, 0.165308, 0.035003, 
		0.020256, 0.022012, 0.035665, 0.024027, 0.016726, 
		0.059857, 0.148010, 0.117498, 0.064545, 0.028763, 
		0.036567, 0.039362, 0.021556, 0.098561, 0.007590, 
		0.021303, 0.047887, 0.051265, 0.062076, 0.037568, 
		0.192620, 0.380430, 0.338868, 0.106981, 0.057625, 
		0.013946, 0.135117, 0.151458, 0.143586, 0.362230, 
		0.017644, 0.014126, 0.025792, 0.053198, 0.042838, 
		0.054811, 0.017372, 0.179047, 0.087866, 0.010929, 
		0.044972, 0.091624, 0.017739, 0.200131, 0.357016, 
		0.008638, 0.007282, 0.033425, 0.008151, 0.012050, 
		0.007668, 0.017343, 0.042875, 0.031399, 0.014441, 
		0.014321, 0.026528, 0.012649, 0.002991, 0.013073, 
		0.003719, 0.022573, 0.013878, 0.007724, 0.020322, 
		0.015195, 0.001314, 0.046822, 0.007562, 0.003460, 
		0.008590, 0.015713, 0.012798, 0.012447, 0.007792, 
		0.035066, 0.029828, 0.018051, 0.004882, 0.017281, 
		0.038099, 0.040959, 0.053474, 0.006322, 0.020476, 
		0.036225, 0.014861, 0.102916, 0.482865, 0.593375, 
		0.795987, 0.429984, 0.131085, 0.041432, 0.026972, 
		0.001169, 0.136370, 0.098688, 0.008007, 0.004690, 
		0.006237, 0.009062, 0.002081, 0.002446, 0.065148, 
		0.025595, 0.072480, 0.039360, 0.004345, 0.013475, 
		0.007369, 0.084695, 0.130170, 0.062352, 0.105372, 
		0.104975, 0.019254, 0.049175, 0.062772, 0.052180, 
		0.004769, 0.017304, 0.009679, 0.002856, 0.004660, 
		0.006564, 0.011561, 0.004498, 0.007897, 0.005614, 
		0.009674, 0.007046, 0.001667, 0.007418, 0.022736, 
		0.012524, 0.008275, 0.001226, 0.003725, 0.010848, 
		0.014882, 0.009183, 0.002246, 0.003778, 0.010940, 
		0.014103, 0.007358, 0.001398, 0.005440, 0.010262, 
		0.009037, 0.003269, 0.002048, 0.006571, 0.011112, 
		0.011212, 0.003262, 0.000965, 0.008133, 0.008698, 
		0.008635, 0.002175, 0.001627, 0.011304, 0.025704, 
		0.001314, 0.001556, 0.003671, 0.024743, 0.007742, 
		0.009249, 0.004272, 0.063453, 0.012234, 0.012073, 
		0.003783, 0.015699, 0.018942, 0.005703, 0.007003, 
		0.008966, 0.002801, 0.013861, 0.002502, 0.003540, 
		0.005818, 0.006703, 0.001676, 0.012764, 0.004265, 
		0.007335, 0.002357, 0.007274, 0.009854, 0.009308, 
		0.003632, 0.005967, 0.005944, 0.005154, 0.004621, 
		0.004702, 0.004627, 0.004702, 0.004621, 0.005154, 
		0.005944, 0.005967, 0.003632, 0.009308, 0.009854, 
		0.007274, 0.002357, 0.007335, 0.004265, 0.012764, 
		0.001676, 0.006703, 0.005818, 0.003540, 0.002502, 
		0.013861, 0.002801, 0.008966, 0.007003, 0.005703, 
		0.018942, 0.015699, 0.003783, 0.012073, 0.012234, 
		0.063453, 0.004272, 0.009249, 0.007742, 0.024743, 
		0.003671, 0.001556, 0.001314, 0.025704, 0.011304, 
		0.001627, 0.002175, 0.008635, 0.008698, 0.008133, 
		0.000965, 0.003262, 0.011212, 0.011112, 0.006571, 
		0.002048, 0.003269, 0.009037, 0.010262, 0.005440, 
		0.001398, 0.007358, 0.014103, 0.010940, 0.003778, 
		0.002246, 0.009183, 0.014882, 0.010848, 0.003725, 
		0.001226, 0.008275, 0.012524, 0.022736, 0.007418, 
		0.001667, 0.007046, 0.009674, 0.005614, 0.007897, 
		0.004498, 0.011561, 0.006564, 0.004660, 0.002856, 
		0.009679, 0.017304, 0.004769, 0.052180, 0.062772, 
		0.049175, 0.019254, 0.104975, 0.105372, 0.062352, 
		0.130170, 0.084695, 0.007369, 0.013475, 0.004345, 
		0.039360, 0.072480, 0.025595, 0.065148, 0.002446, 
		0.002081, 0.009062, 0.006237, 0.004690, 0.008007, 
		0.098688, 0.136370, 0.001169, 0.026972, 0.041432, 
		0.131085, 0.429984, 0.795987, 0.593375, 0.482865, 
		0.102916, 0.014861, 0.036225, 0.020476, 0.006322, 
		0.053474, 0.040959, 0.038099, 0.017281, 0.004882, 
		0.018051, 0.029828, 0.035066, 0.007792, 0.012447, 
		0.012798, 0.015713, 0.008590, 0.003460, 0.007562, 
		0.046822, 0.001314, 0.015195, 0.020322, 0.007724, 
		0.013878, 0.022573, 0.003719, 0.013073, 0.002991, 
		0.012649, 0.026528, 0.014321, 0.014441, 0.031399, 
		0.042875, 0.017343, 0.007668, 0.012050, 0.008151, 
		0.033425, 0.007282, 0.008638, 0.357016, 0.200131, 
		0.017739, 0.091624, 0.044972, 0.010929, 0.087866, 
		0.179047, 0.017372, 0.054811, 0.042838, 0.053198, 
		0.025792, 0.014126, 0.017644, 0.362230, 0.143586, 
		0.151458, 0.135117, 0.013946, 0.057625, 0.106981, 
		0.338868, 0.380430, 0.192620, 0.037568, 0.062076, 
		0.051265, 0.047887, 0.021303, 0.007590, 0.098561, 
		0.021556, 0.039362, 0.036567, 0.028763, 0.064545, 
		0.117498, 0.148010, 0.059857, 0.016726, 0.024027, 
		0.035665, 0.022012, 0.020256, 0.035003, 0.165308, 
		0.069056, 0.055376, 0.037812, 0.053567, 0.053132, 
		0.044489, 0.029452, 0.089145, 0.074780, 0.073363, 
		0.082810, 0.068336, 0.092254, 0.205801, 0.209080, 
		0.119952, 0.085671, 0.084745, 0.092987, 0.084770, 
		0.045324, 0.164202, 1.174374, 0.508701, 0.383969, 
		0.347916, 0.321845, 0.341362, 0.226787, 0.750571, 
		1.403078, 1.123026, 1.441215, 2.250918, 2.991733, 
		6.761722, 36.911399, 271.429382, 10.366660, 2.675012, 
		2.075968, 3.723117, 5.598753, 16.551824, 179.534998, 
		57.028617, 8.522785, 3.061320, 1.581736, 0.908976, 
		0.615122, 0.401178
};

void calc_bank_gain(void)
{
	float temp;

	int bank_num;
	for (bank_num = 0; bank_num < 20; bank_num++) {
		int x_length_inc = bank_border[bank_num+1] - bank_border[bank_num];
		int x_length_dec = bank_border[bank_num+2] - bank_border[bank_num+1];

		int offset = bank_border[bank_num] / 125;

		int index = 1;
		int frequency_x4 = (index+offset) * 125;

		while (frequency_x4 <= bank_border[bank_num+1]) {
			temp = (float)(frequency_x4 - bank_border[bank_num]) / (float)x_length_inc;
			bank_gain[bank_num][index-1] = float_to_fr16(temp);
			index++;
			frequency_x4 = (index+offset) * 125;
		}

		while( frequency_x4 <= bank_border[bank_num+2] ) {
			temp = 1 - (float)(frequency_x4 - bank_border[bank_num+1]) / (float)x_length_dec;
			bank_gain[bank_num][index-1] = float_to_fr16(temp);
			index++;
			frequency_x4 = (index+offset) * 125;
		}
	}
}

void mel_filter(fract16 power_fr[], float energy_melband[])
{
	int bank_num;
	for (bank_num = 0; bank_num < 20; bank_num++) {
		int offset = bank_border[bank_num]/125;

		int L = bank_border[bank_num+2]/125 - bank_border[bank_num]/125;

		int index;
		for (index = 0; index < L; index++) {
			fract32 temp = mult_fr1x32(power_fr[index+offset+1], bank_gain[bank_num][index]);
			energy_melband[bank_num] = energy_melband[bank_num] + fr32_to_float(temp);
		}

		energy_melband[bank_num] = energy_melband[bank_num] * (1<<8);
		energy_melband[bank_num] = log10f(energy_melband[bank_num]);
	}
}

int main() {
	calc_bank_gain();

	fract16 power_fr[512];
	int i;
	for (i = 0; i < 512; ++i) {
		power_fr[i] = float_to_fr16(power[i] / (1<<8));
	}

	float energy_melband[20] = {0.0};
	mel_filter(power_fr, energy_melband);

	int bank_num;
	for (bank_num = 0; bank_num < 20; bank_num++) {
		printf("%f\t", energy_melband[bank_num]);
	}
	return 0;
}
